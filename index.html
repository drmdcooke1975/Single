<head>
  <meta charset="UTF-8" />
  <title>Middle-Earth Match Simulator</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: #f0f0f0;
      font-family: 'Georgia', serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    #team1Name { color: #d4af37; font-weight: bold; }
    #team2Name { color: #90ee90; font-weight: bold; }

    #scoreboard {
      border: 2px solid #ccc;
      padding: 10px;
      background-color: #2c2c2c;
      border-radius: 8px;
      font-size: 24px;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #passage {
      font-size: 20px;
      font-style: italic;
      margin-top: 20px;
    }

    #commentaryBox {
      font-style: italic;
      color: #ccc;
      margin-top: 15px;
      font-size: 18px;
      white-space: pre-line;
    }

    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover { background-color: #666; }

    select {
      font-size: 16px;
      padding: 6px;
      margin-top: 10px;
    }

    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.85);
      color: #f0f0f0;
      font-size: 24px;
      font-family: 'Georgia', serif;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #loadingOverlay div { text-align: center; }

    /* ü™Ñ Animations */
    @keyframes goalFlash {
      0%   { background-color: #2c2c2c; }
      50%  { background-color: gold; }
      100% { background-color: #2c2c2c; }
    }

    @keyframes tacticPulse {
      0%   { transform: scale(1); }
      50%  { transform: scale(1.2); }
      100% { transform: scale(1); }
    }

    @keyframes runeDrift {
      0%   { opacity: 0; transform: translateY(10px); }
      50%  { opacity: 0.6; transform: translateY(-5px); }
      100% { opacity: 0; transform: translateY(-20px); }
    }

    .flash { animation: goalFlash 0.8s ease; }
    .pulse { animation: tacticPulse 0.5s ease; }

    .runeSparkle {
      animation: runeDrift 1.2s ease-in-out;
      position: absolute;
      font-size: 20px;
      left: 50%;
      top: 60%;
      transform: translate(-50%, -50%);
      color: gold;
      pointer-events: none;
      z-index: 10;
    }

    /* üß≠ Tactical Map Zones */
    #tacticalMap rect {
      transition: fill 0.4s ease;
    }
  </style>
</head>


<body>
  <h1>Middle-Earth Match Simulator</h1>

  <div id="scoreboard">
    <span id="team1Name" style="margin-right: 15px;">üõ°Ô∏è Dwarves of Khazad-d√ªm</span>
    <strong id="team1Score">0</strong>
    <span style="margin: 0 10px;">‚öîÔ∏è</span>
    <strong id="team2Score">0</strong>
    <span id="team2Name" style="margin-left: 15px;">üåø Elves of Lothl√≥rien</span>
  </div>

  <label for="team1Tactic">Dwarven Tactical Choice:</label>
  <br />
  <select id="team1Tactic">
    <option value="Attack" title="Charge forth with fury">Attack</option>
    <option value="Hold" title="Brace against the storm" selected>Hold</option>
    <option value="Defend" title="Guard the ancient walls">Defend</option>
  </select>

  <p id="commentaryBox">Let the clash begin under ancient skies‚Ä¶</p>
  <p id="passage">Loading passage...</p>
  <p id="matchScore">Loading score...</p>
  <p id="debugLogs">Debug Logs: Awaiting response...</p>
  <p id="gameStatus">Awaiting game start...</p>
  <p id="passageCounter">Passages Played: 0</p>

  <svg id="tacticalMap" width="320" height="100" style="margin-top: 20px; border: 2px solid #ccc; border-radius: 8px;">
    <rect id="zoneLeft" x="0" y="0" width="106" height="100" fill="#2c2c2c" />
    <rect id="zoneCenter" x="106" y="0" width="106" height="100" fill="#2c2c2c" />
    <rect id="zoneRight" x="212" y="0" width="108" height="100" fill="#2c2c2c" />
  </svg>

  <button id="startGameButton">Start Game Passage</button>
  <button id="resetGameButton">Reset Game</button>

  <div id="loadingOverlay">
    <div>
      üßô‚Äç‚ôÇÔ∏è Preparing passage...<br />
      <span style="font-size: 16px;">The winds of fate are shifting‚Ä¶</span>
    </div>
  </div>
</body>

<script>
  const scriptURL = "https://script.google.com/macros/s/AKfycbzQKcCU7_ArCPIxVBLq57gMM1m8S5Cm68hwh_2-0e8WITo4GgXMnPnqo9C5h0V9kf5dZQ/exec";

  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("startGameButton").addEventListener("click", playPassage);
    document.getElementById("resetGameButton").addEventListener("click", resetGame);

    function playPassage() {
      document.getElementById("loadingOverlay").style.display = "flex";

      const tactic = document.getElementById("team1Tactic").value;
      const sessionID = "player_" + Math.floor(Math.random() * 100000); // Simple session generator

      const url = `${scriptURL}?action=passage&tactic=${encodeURIComponent(tactic)}&sessionID=${sessionID}&t=${Date.now()}`;
      document.getElementById("debugLogs").innerText = "[START GAME] Fetching passage...";

      fetch(url)
        .then(response => response.json())
        .then(data => {
          document.getElementById("loadingOverlay").style.display = "none";
          const passageData = data.passageData || {};

          // Match UI updates
          document.getElementById("team1Score").innerText = passageData.team1Score || "0";
          document.getElementById("team2Score").innerText = passageData.team2Score || "0";
          document.getElementById("gameStatus").innerText = "Game Started!";
          document.getElementById("passage").innerText = passageData.passageOfPlay || "No passage returned.";
          document.getElementById("matchScore").innerText = passageData.matchScore || "Score unavailable.";
          document.getElementById("passageCounter").innerText = `Passages Played: ${passageData.passagesPlayed}`;

          // Tactical map update
          const zoneLeft = document.getElementById("zoneLeft");
          const zoneCenter = document.getElementById("zoneCenter");
          const zoneRight = document.getElementById("zoneRight");

          zoneLeft.setAttribute("fill", "#2c2c2c");
          zoneCenter.setAttribute("fill", "#2c2c2c");
          zoneRight.setAttribute("fill", "#2c2c2c");

          const possessionColor = passageData.possessionWinner === "Team 1" ? "#d4af37" : "#90ee90";
          zoneCenter.setAttribute("fill", possessionColor);

          // Goal effects
          if (passageData.passageOfPlay.includes("GOAL")) {
            const scoreboard = document.getElementById("scoreboard");
            scoreboard.classList.add("flash");
            setTimeout(() => scoreboard.classList.remove("flash"), 800);
            spawnRuneSparkle("‚öΩ");
          }

          // Tactic pulse
          const tacticDropdown = document.getElementById("team1Tactic");
          tacticDropdown.classList.add("pulse");
          setTimeout(() => tacticDropdown.classList.remove("pulse"), 500);

          // Commentary logic
          let commentary = "";
          if (passageData.passageOfPlay.includes("GOAL")) {
            commentary = passageData.possessionWinner === "Team 1"
              ? "A mighty blow lands from beneath the mountain halls!"
              : "Swift as starlight, the Elves strike true!";
          } else {
            commentary = passageData.possessionWinner === "Team 1"
              ? "Axes gleam as Khazad-d√ªm holds the line."
              : "Leaves whisper as Lothl√≥rien secures control.";
          }

          if (passageData.passagesPlayed > 7) {
            commentary += " The tension thickens in the final passages...";
          }

          typeCommentary(commentary);

          // Debug logs
          let logOutput = "[LOGS]\n";
          logOutput += `Passage Count: ${passageData.passagesPlayed}\n`;
          logOutput += `Team 1 Tactic: ${passageData.team1Tactic}\n`;
          logOutput += `Team 2 Tactic: ${passageData.team2Tactic}\n`;
          logOutput += `Possession Winner: ${passageData.possessionWinner}\n`;
          logOutput += `Score: ${passageData.team1Score} - ${passageData.team2Score}\n\n`;

          if (Array.isArray(passageData.debugLogs)) {
            logOutput += passageData.debugLogs.join("\n");
          }
          document.getElementById("debugLogs").innerText = logOutput;
        })
        .catch(error => {
          document.getElementById("loadingOverlay").style.display = "none";
          document.getElementById("debugLogs").innerText = `Error: ${error.message}`;
        });
    }

    function resetGame() {
      document.getElementById("loadingOverlay").style.display = "flex";

      const sessionID = "player_" + Math.floor(Math.random() * 100000); // Match reset ID
      const url = `${scriptURL}?action=resetGameData&sessionID=${sessionID}&t=${Date.now()}`;
      document.getElementById("debugLogs").innerText = "[RESET GAME] Resetting game...";

      fetch(url)
        .then(response => response.json())
        .then(data => {
          document.getElementById("loadingOverlay").style.display = "none";
          document.getElementById("gameStatus").innerText = "Game Reset.";
          document.getElementById("passage").innerText = "";
          document.getElementById("matchScore").innerText = "";
          document.getElementById("team1Score").innerText = "0";
          document.getElementById("team2Score").innerText = "0";
          typeCommentary("Let the clash begin under ancient skies‚Ä¶");

          const logs = Array.isArray(data.debugLogs)
            ? data.debugLogs.join("\n")
            : data.debugLogs || "Reset complete.";
          document.getElementById("debugLogs").innerText = logs;
        })
        .catch(error => {
          document.getElementById("loadingOverlay").style.display = "none";
          document.getElementById("debugLogs").innerText = `Error: ${error.message}`;
        });
    }

    function typeCommentary(text) {
      const box = document.getElementById("commentaryBox");
      box.textContent = "";
      box.style.whiteSpace = "pre-line";
      let i = 0;
      const timer = setInterval(() => {
        box.textContent += text.charAt(i);
        i++;
        if (i === text.length) clearInterval(timer);
      }, 25);
    }

    function spawnRuneSparkle(char) {
      const sparkle = document.createElement("div");
      sparkle.className = "runeSparkle";
      sparkle.textContent = char;
      document.body.appendChild(sparkle);
      setTimeout(() => sparkle.remove(), 1200);
    }
  });
</script>

</body>
</html>

