<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Middle-earth Match Simulator</title>
  <style>
    body {
      background-color: #1c1c1c;
      color: #f0f0f0;
      font-family: 'Georgia', serif;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    #team1Name { color: #d4af37; font-weight: bold; }
    #team2Name { color: #90ee90; font-weight: bold; }

    #scoreboard {
      border: 2px solid #ccc;
      padding: 10px;
      background-color: #2c2c2c;
      border-radius: 8px;
      font-size: 24px;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #passage {
      font-size: 20px;
      font-style: italic;
      margin-top: 20px;
    }

    #commentaryBox {
      font-style: italic;
      color: #ccc;
      margin-top: 15px;
      font-size: 18px;
    }

    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 18px;
      background-color: #444;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover { background-color: #666; }

    select {
      font-size: 16px;
      padding: 6px;
      margin-top: 10px;
    }

    #loadingOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.85);
      color: #f0f0f0;
      font-size: 24px;
      font-family: 'Georgia', serif;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }

    #loadingOverlay div { text-align: center; }
  </style>
</head>
<body>
  <h1>Middle-earth Match Simulator</h1>

  <div id="scoreboard">
    <span id="team1Name" style="margin-right: 15px;">üõ°Ô∏è Dwarves of Khazad-d√ªm</span>
    <strong id="team1Score">0</strong>
    <span style="margin: 0 10px;">‚öîÔ∏è</span>
    <strong id="team2Score">0</strong>
    <span id="team2Name" style="margin-left: 15px;">üåø Elves of Lothl√≥rien</span>
  </div>

  <label for="team1Tactic">Dwarven Tactical Choice:</label>
  <br />
  <select id="team1Tactic">
    <option value="Attack">Attack</option>
    <option value="Hold" selected>Hold</option>
    <option value="Defend">Defend</option>
  </select>

  <p id="commentaryBox">Let the clash begin under ancient skies‚Ä¶</p>
  <p id="passage">Loading passage...</p>
  <p id="matchScore">Loading score...</p>
  <p id="debugLogs">Debug Logs: Awaiting response...</p>
  <p id="gameStatus">Awaiting game start...</p>

  <button id="startGameButton">Start Game</button>
  <button id="resetGameButton">Reset Game</button>

  <div id="loadingOverlay">
    <div>
      üßô‚Äç‚ôÇÔ∏è Preparing passage...<br />
      <span style="font-size: 16px;">The winds of fate are shifting‚Ä¶</span>
    </div>
  </div>

  <script>

        const scriptURL = "https://script.google.com/macros/s/AKfycbz5MdJYwHekkwAYZ2vI5JNX6sWbrhZ-BdI-2zjHn6yfP01ycJWkapOHeoT3ITPbVojrDg/exec";

    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("startGameButton").addEventListener("click", playPassage);
      document.getElementById("resetGameButton").addEventListener("click", resetGame);

      function playPassage() {
        document.getElementById("loadingOverlay").style.display = "flex";

        const tactic = document.getElementById("team1Tactic").value;
        const url = `${scriptURL}?action=passage&tactic=${encodeURIComponent(tactic)}&t=${Date.now()}`;
        document.getElementById("debugLogs").innerText = "[START GAME] Fetching passage...";

        fetch(url)
          .then(response => response.json())
          .then(data => {
            document.getElementById("loadingOverlay").style.display = "none";
            const passageData = data.passageData || {};

            document.getElementById("team1Score").innerText = passageData.team1Score || "0";
            document.getElementById("team2Score").innerText = passageData.team2Score || "0";
            document.getElementById("gameStatus").innerText = "Game Started!";
            document.getElementById("passage").innerText = passageData.passageOfPlay || "No passage returned.";
            document.getElementById("matchScore").innerText = passageData.matchScore || "Score unavailable.";

            if (passageData.passageOfPlay && passageData.passageOfPlay.includes("GOAL")) {
              const scoreboard = document.getElementById("scoreboard");
              scoreboard.style.backgroundColor = passageData.possessionWinner === "Team 1" ? "#d4af37" : "#90ee90";
              setTimeout(() => scoreboard.style.backgroundColor = "#2c2c2c", 800);
            }

            let commentary = "";
            if (passageData.passageOfPlay.includes("GOAL")) {
              commentary = passageData.possessionWinner === "Team 1"
                ? "A mighty blow lands from beneath the mountain halls!"
                : "Swift as starlight, the Elves strike true!";
            } else {
              commentary = passageData.possessionWinner === "Team 1"
                ? "Axes gleam as Khazad-d√ªm holds the line."
                : "Leaves whisper as Lothl√≥rien secures control.";
            }
            document.getElementById("commentaryBox").innerText = commentary;

            let logOutput = "[LOGS]\n";
            logOutput += `Passage Count: ${passageData.passagesPlayed}\n`;
            logOutput += `Team 1 Tactic: ${passageData.team1Tactic}\n`;
            logOutput += `Team 2 Tactic: ${passageData.team2Tactic}\n`;
            logOutput += `Possession Winner: ${passageData.possessionWinner}\n`;
            logOutput += `Score: ${passageData.team1Score} - ${passageData.team2Score}\n\n`;

            if (Array.isArray(passageData.debugLogs)) {
              logOutput += passageData.debugLogs.join("\n");
            }
            document.getElementById("debugLogs").innerText = logOutput;
          })
          .catch(error => {
            document.getElementById("loadingOverlay").style.display = "none";
            document.getElementById("debugLogs").innerText = `Error: ${error.message}`;
          });
      }

      function resetGame() {
        document.getElementById("loadingOverlay").style.display = "flex";
        const url = `${scriptURL}?action=resetGameData&t=${Date.now()}`;
        document.getElementById("debugLogs").innerText = "[RESET GAME] Resetting game...";

        fetch(url)
          .then(response => response.json())
          .then(data => {
            document.getElementById("loadingOverlay").style.display = "none";
            document.getElementById("gameStatus").innerText = "Game Reset.";
            document.getElementById("passage").innerText = "";
            document.getElementById("matchScore").innerText = "";
            document.getElementById("team1Score").innerText = "0";
            document.getElementById("team2Score").innerText = "0";
            document.getElementById("commentaryBox").innerText = "Let the clash begin under ancient skies‚Ä¶";

            const logs = Array.isArray(data.debugLogs)
              ? data.debugLogs.join("\n")
              : data.debugLogs || "Reset complete.";
            document.getElementById("debugLogs").innerText = logs;
          })
          .catch(error => {
            document.getElementById("loadingOverlay").style.display = "none";
            document.getElementById("debugLogs").innerText = `Error: ${error.message}`;
          });
      }
    });
  </script>
</body>
</html>
